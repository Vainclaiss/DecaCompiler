stages:
  - build
  - sonar

variables:
  SONAR_TOKEN: $SONAR_TOKEN
  SONAR_HOST_URL: $SONAR_HOST_URL
  SONAR_PROJECT_KEY: $SONAR_PROJECT_KEY

cache:
  paths:
    - .m2/repository
    - .sonar/cache

before_script:
  - export MAVEN_CLI_OPTS="--batch-mode --errors --fail-at-end --show-version --update-snapshots"

build:
  stage: build
  image: maven:3.8.5-jdk-17
  script:
    - mvn $MAVEN_CLI_OPTS clean verify

sonarqube_scan:
  stage: sonar
  image: maven:3.8.5-jdk-17
  script:
    - mvn $MAVEN_CLI_OPTS org.sonarsource.scanner.maven:sonar-maven-plugin:sonar
  only:
    - develop
    - main
  variables:
    GIT_DEPTH: "0" # Ensure full repository history is available for SonarQube analysis
